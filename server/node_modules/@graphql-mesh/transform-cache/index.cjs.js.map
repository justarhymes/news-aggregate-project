{"version":3,"file":"index.cjs.js","sources":["../../../dist/transforms/cache/src/compute-cache-key.js","../../../dist/transforms/cache/src/index.js"],"sourcesContent":["import objectHash from 'object-hash';\nimport { stringInterpolator } from '@graphql-mesh/utils';\nimport graphqlFields from 'graphql-fields';\nexport function computeCacheKey(options) {\n    const argsHash = options.args ? objectHash(options.args, { ignoreUnknown: true }) : '';\n    const fieldsObj = graphqlFields(options.info);\n    const fieldNamesHash = objectHash(fieldsObj, { ignoreUnknown: true });\n    if (!options.keyStr) {\n        return `${options.info.parentType.name}-${options.info.fieldName}-${argsHash}-${fieldNamesHash}`;\n    }\n    const templateData = {\n        args: options.args,\n        argsHash,\n        fieldNamesHash,\n        info: options.info || null,\n    };\n    return stringInterpolator.parse(options.keyStr, templateData);\n}\n//# sourceMappingURL=compute-cache-key.js.map","import { composeResolvers } from '@graphql-tools/resolvers-composition';\nimport { computeCacheKey } from './compute-cache-key';\nimport { extractResolvers } from '@graphql-mesh/utils';\nimport { addResolversToSchema } from '@graphql-tools/schema';\nexport default class CacheTransform {\n    constructor(options) {\n        this.options = options;\n    }\n    transformSchema(schema) {\n        var _a;\n        const { config, hooks, cache } = this.options;\n        const sourceResolvers = extractResolvers(schema);\n        const compositions = {};\n        for (const cacheItem of config) {\n            const effectingOperations = ((_a = cacheItem.invalidate) === null || _a === void 0 ? void 0 : _a.effectingOperations) || [];\n            if (effectingOperations.length > 0) {\n                hooks.on('resolverDone', async (resolverInfo) => {\n                    const effectingRule = effectingOperations.find(o => o.operation === `${resolverInfo.info.parentType.name}.${resolverInfo.info.fieldName}`);\n                    if (effectingRule) {\n                        const cacheKey = computeCacheKey({\n                            keyStr: effectingRule.matchKey,\n                            args: resolverInfo.args,\n                            info: resolverInfo.info,\n                        });\n                        await cache.delete(cacheKey);\n                    }\n                });\n            }\n            compositions[cacheItem.field] = (originalResolver => async (root, args, context, info) => {\n                var _a;\n                const cacheKey = computeCacheKey({\n                    keyStr: cacheItem.cacheKey,\n                    args,\n                    info,\n                });\n                const cachedValue = await cache.get(cacheKey);\n                if (cachedValue) {\n                    return cachedValue;\n                }\n                const resolverResult = await originalResolver(root, args, context, info);\n                await cache.set(cacheKey, resolverResult, {\n                    ttl: ((_a = cacheItem.invalidate) === null || _a === void 0 ? void 0 : _a.ttl) || undefined,\n                });\n                return resolverResult;\n            });\n        }\n        const wrappedResolvers = composeResolvers(sourceResolvers, compositions);\n        return addResolversToSchema({\n            schema,\n            resolvers: wrappedResolvers,\n            updateResolversInPlace: true,\n        });\n    }\n}\n//# sourceMappingURL=index.js.map"],"names":["stringInterpolator","schema","extractResolvers","composeResolvers","addResolversToSchema"],"mappings":"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"}